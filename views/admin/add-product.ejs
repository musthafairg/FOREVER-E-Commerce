<%- include("../../views/partials/admin/header") %>
<head>
    <!-- CropperJS CSS removed -->
</head>
<style>
    .error-message {
        color: red;
        display: none; /* Ensure error messages start hidden */
    }
    .thumbnails-container {
        display: flex;
        overflow-x: auto;
        padding: 10px;
    }
    .thumbnail {
        margin-right: 10px;
        position: relative;
    }
    /* Simple preview images if needed */
    .img-preview {
        max-width: 100%;
        height: auto;
        display: block;
        max-height: 150px;
        margin-bottom: 10px;
    }
    /* Generic crop container for manual cropping */
    .crop-container {
        width: 400px;
        height: 400px;
        border: 1px solid #777;
        margin-top: 10px;
        position: relative;
        overflow: hidden;
        background-color: #f7f7f7;
    }
    .crop-main-image {
        max-width: none;
        position: absolute;
        top: 0;
        left: 0;
    }
    .crop-area {
        border: 2px dashed #00a2ff;
        position: absolute;
        cursor: move;
        resize: both;
        overflow: auto;
        min-width: 50px;
        min-height: 50px;
    }
    .crop-preview img {
        max-width: 300px;
        margin-top: 10px;
        display: block;
    }
</style>

<div class="main-layout">
        
    <aside class="sidebar">
        <nav class="sidebar-nav">
            <ul>
                <li class="<%= locals.page === 'dashboard' ? 'active' : '' %>">
                    <a href="/admin" style="color: inherit; text-decoration: none; display: flex; align-items: center; width: 100%; height: 100%;">
                        <i class="fas fa-tachometer-alt"></i>
                        Dashboard
                    </a>
                </li>
                <li class="<%= locals.page === 'addProducts' ? 'active' : '' %>">
                    <a href="/admin/addProducts" style="color: inherit; text-decoration: none; display: flex; align-items: center; width: 100%; height: 100%;">
                        <i class="fas fa-plus-circle"></i>
                        Add Products
                    </a>
                </li>
                <li class="<%= locals.page === 'products' ? 'active' : '' %>">
                    <a href="/admin/products" style="color: inherit; text-decoration: none; display: flex; align-items: center; width: 100%; height: 100%;">
                        <i class="fas fa-list"></i>
                        Products
                    </a>
                </li>
                <li class="<%= locals.page === 'brands' ? 'active' : '' %>">
                    <a href="/admin/brands" style="color: inherit; text-decoration: none; display: flex; align-items: center; width: 100%; height: 100%;">
                        <i class="fas fa-clipboard-list"></i>
                        Brands
                    </a>
                </li>
                <li class="<%= locals.page === 'users' ? 'active' : '' %>">
                    <a href="/admin/users" style="color: inherit; text-decoration: none; display: flex; align-items: center; width: 100%; height: 100%;">
                        <i class="fas fa-users"></i>
                        Users
                    </a>
                </li>
                <li>
                    <a href="/admin/coupons" style="color: inherit; text-decoration: none; display: flex; align-items: center; width: 100%; height: 100%;">
                        <i class="fas fa-tags"></i>
                        Coupons
                    </a>
                </li>
                <li>
                    <a href="/admin/sales-report" style="color: inherit; text-decoration: none; display: flex; align-items: center; width: 100%; height: 100%;">
                        <i class="fas fa-chart-line"></i>
                        Sales Report
                    </a>
                </li>
                <li class="<%= locals.page === 'category' ? 'active' : '' %>">
                    <a href="/admin/category" style="color: inherit; text-decoration: none; display: flex; align-items: center; width: 100%; height: 100%;">
                        <i class="fas fa-folder-open"></i>
                        Category
                    </a>
                </li>
                <li>
                    <a href="/admin/offers" style="color: inherit; text-decoration: none; display: flex; align-items: center; width: 100%; height: 100%;">
                        <i class="fas fa-gift"></i>
                        Offers
                    </a>
                </li>
            </ul>
        </nav>
    </aside>

    <section class="content-main">
        <div class="row">
            <div class="col-9">
                <div class="content-header">
                    <h2 class="content-title">Add New Product</h2>
                </div>
            </div>
            <div class="col-lg-12">
                <div class="card mb-4">
                    <div class="card-body">
                        <form method="POST" action="/admin/addProducts" id="productForm" enctype="multipart/form-data"
                            onsubmit="return validateForm()"> 
                            <input type="hidden" id="imageDatas" name="imageDatas"> 

                            <div class="mb-4">
                                <label for="product_name" class="form-label">Product Name</label>
                                <input type="text" placeholder="Type here" name="productName"
                                    class="form-control border" id="product_name">
                                <div id="productName-error" class="error-message"></div>
                            </div>
                            <div class="col-lg-4 mb-4">
                                <label class="form-label">Brand</label>
                                <select class="form-select border" name="brand">
                                    <% for (let i=0; i<brand.length; i++) { %>
                                        <option value="<%= brand[i].brandName %>">
                                            <%= brand[i].brandName %>
                                        </option>
                                    <% } %>
                                </select>
                                <div id="brand-error" class="error-message"></div>
                            </div>
                            <div class="mb-4">
                                <label class="form-label">Full description</label>
                                <textarea placeholder="Type here" id="descriptionid" name="descriptionData" class="form-control border"
                                    rows="4"></textarea>
                                <div id="description-error" class="error-message"></div>
                            </div>
                            <div class="row">
                                <div class="col-lg-4">
                                    <div class="mb-4">
                                        <label class="form-label">Regular price</label>
                                        <input placeholder="$" name="regularPrice" type="text"
                                            class="form-control border">
                                        <div id="regularPrice-error" class="error-message"></div>
                                    </div>
                                </div>
                                <div class="col-lg-4">
                                    <div class="mb-4">
                                        <label class="form-label">Sale price</label>
                                        <input placeholder="$" name="salePrice" type="text" class="form-control border">
                                        <div id="salePrice-error" class="error-message"></div>
                                    </div>
                                </div>
                                <div class="col-lg-4">
                                    <div class="mb-4">
                                        <label class="form-label">Quantity</label>
                                        <input placeholder="" name="quantity" type="text" class="form-control border">
                                        <div id="quantity-error" class="error-message"></div>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                
                                <div class="col-lg-4">
                                    <div class="mb-4">
                                        <label class="form-label">Color</label>
                                        <input name="color" type="text" class="form-control border">
                                    </div>
                                    <div id="color-error" class="error-message"></div>
                                </div>
                            
                            </div>
                            <div class="card mb-4">
                                <div class="card-body">
                                    <div class="row gx-2">
                                        <div class="col-sm-6 mb-3">
                                            <label class="form-label">Category</label>
                                            <select class="form-select border" style="width: 150px;" name="category">
                                                <% for (let i=0; i<cat.length; i++) { %>
                                                    <option value="<%= cat[i].name %>">
                                                        <%= cat[i].name %>
                                                    </option>
                                                <% } %>
                                            </select>
                                            <div id="category-error" class="error-message"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- IMAGES + MANUAL CROP SECTION -->
                            <div class="card mb-2">
                                <div class="card-header">
                                    <h4>Choose images</h4>
                                </div>
                                <div class="border row">
                                    <div id="addedImagesContainer" class="thumbnails-container"></div>
                                </div>

                                <!-- Image 1 -->
                                <div class="row">
                                    <div class="card-body align-items-center" style="margin-bottom: 20px;">
                                        <label class="form-label">Image 1</label>
                                        <input class="form-control" type="file" name="images" id="input1"
                                            accept="image/png, image/jpeg, image/jpg"
                                            onchange="onFileChange(event, 1)">
                                        <div id="images-error" class="error-message"></div>

                                        <div id="container1" class="crop-container" style="display:none;">
                                            <img id="mainImage1" class="crop-main-image" />
                                            <div id="crop-area1" class="crop-area"></div>
                                        </div>
                                        <button type="button" id="cropBtn1" class="btn-sm btn-primary mt-2" style="display:none;">
                                            Crop Image 1
                                        </button>
                                        <div id="preview1" class="crop-preview"></div>
                                    </div>
                                </div>

                                <!-- Image 2 -->
                                <div class="row">
                                    <div class="card-body align-items-center" style="margin-bottom: 20px;">
                                        <label class="form-label">Image 2</label>
                                        <input class="form-control" type="file" name="images" id="input2"
                                            accept="image/png, image/jpeg, image/jpg"
                                            onchange="onFileChange(event, 2)">

                                        <div id="container2" class="crop-container" style="display:none;">
                                            <img id="mainImage2" class="crop-main-image" />
                                            <div id="crop-area2" class="crop-area"></div>
                                        </div>
                                        <button type="button" id="cropBtn2" class="btn-sm btn-primary mt-2" style="display:none;">
                                            Crop Image 2
                                        </button>
                                        <div id="preview2" class="crop-preview"></div>
                                    </div>
                                </div>

                                <!-- Image 3 -->
                                <div class="row">
                                    <div class="card-body align-items-center" style="margin-bottom: 20px;">
                                        <label class="form-label">Image 3</label>
                                        <input class="form-control" type="file" name="images" id="input3"
                                            accept="image/png, image/jpeg, image/jpg"
                                            onchange="onFileChange(event, 3)">

                                        <div id="container3" class="crop-container" style="display:none;">
                                            <img id="mainImage3" class="crop-main-image" />
                                            <div id="crop-area3" class="crop-area"></div>
                                        </div>
                                        <button type="button" id="cropBtn3" class="btn-sm btn-primary mt-2" style="display:none;">
                                            Crop Image 3
                                        </button>
                                        <div id="preview3" class="crop-preview"></div>
                                    </div>
                                </div>

                                <!-- Image 4 -->
                                <div class="row">
                                    <div class="card-body align-items-center" style="margin-bottom: 20px;">
                                        <label class="form-label">Image 4</label>
                                        <input class="form-control" type="file" name="images" id="input4"
                                            accept="image/png, image/jpeg, image/jpg"
                                            onchange="onFileChange(event, 4)">

                                        <div id="container4" class="crop-container" style="display:none;">
                                            <img id="mainImage4" class="crop-main-image" />
                                            <div id="crop-area4" class="crop-area"></div>
                                        </div>
                                        <button type="button" id="cropBtn4" class="btn-sm btn-primary mt-2" style="display:none;">
                                            Crop Image 4
                                        </button>
                                        <div id="preview4" class="crop-preview"></div>
                                    </div>
                                </div>
                            </div>

                            <div>
                                <button class="btn btn-md rounded font-sm hover-up" type="button" onclick="validateAndSubmit()" style="background-color: black; color: #f7f7f7;">Publish</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
   </section>

<!-- CropperJS script removed -->
<script>
    /*******************
     * FORM VALIDATION *
     *******************/
    function validateAndSubmit() {
        if (validateForm()) {
            document.getElementById('productForm').submit();
        }
    }

    function validateForm() {
        let imageDatas = false;
        clearErrorMessages();

        const name = document.getElementsByName('productName')[0].value;
        const description = document.getElementsByName('descriptionData')[0].value; 
        const brand = document.getElementsByName('brand')[0].value;
        const price = document.getElementsByName('regularPrice')[0].value;
        const saleprice = document.getElementsByName('salePrice')[0].value;
        const color = document.getElementsByName('color')[0].value;
        const category = document.getElementsByName('category')[0].value;
        const quantity = document.getElementsByName('quantity')[0].value;
        imageDatas = document.getElementById("imageDatas")?.value;

        let isValid = true; 	

        // 1. Product Name Validation
        if (name.trim() === "") {
            displayErrorMessage('productName-error', 'Please enter a product name.');
            isValid = false;
        }

        // 2. Description Validation
        if (description.trim() === '') {
            displayErrorMessage('description-error', 'Please enter a product description.');
            isValid = false;
        } 

        // 3. Quantity Validation
        const quantityVal = parseInt(quantity);
        if (isNaN(quantityVal) || quantityVal < 0) {
            displayErrorMessage('quantity-error', 'Please enter a valid non-negative integer quantity.');
            isValid = false;
        }

        // 4. Regular Price Validation
        if (!/^\d+(\.\d{1,2})?$/.test(price) || parseFloat(price) < 0) {
            displayErrorMessage('regularPrice-error', 'Please enter a valid non-negative price (e.g., 10 or 10.50).');
            isValid = false;
        }

        // 5. Sale Price Validation
        const salePriceVal = parseFloat(saleprice);
        const regularPriceVal = parseFloat(price);
        if (!/^\d+(\.\d{1,2})?$/.test(saleprice) || salePriceVal < 0) {
            displayErrorMessage('salePrice-error', 'Please enter a valid non-negative sale price.');
            isValid = false;
        } else if (regularPriceVal > 0 && salePriceVal >= regularPriceVal) {
            displayErrorMessage('salePrice-error', 'Sale price must be less than the regular price.');
            isValid = false;
        }

        // 6. Color Validation
        if (color.trim() === "") {
            displayErrorMessage('color-error', 'Please enter a color.');
            isValid = false;
        }

        // 7. Image Validation (input1..input4 OR existing imageDatas)
        let imagesSelected = false;
        for (let i = 1; i <= 4; i++) {
            const input = document.getElementById(`input${i}`);
            if (input && input.files && input.files.length > 0) {
                imagesSelected = true;
                break;
            }
        }
        if (!imageDatas && !imagesSelected) {
            displayErrorMessage("images-error", 'Please select at least one image.');
            isValid = false;
        }
        
        return isValid;
    }

    function displayErrorMessage(elementId, message) {
        var errorElement = document.getElementById(elementId);
        if (!errorElement) return;
        errorElement.innerText = message;
        errorElement.style.display = "block";
    }

    function clearErrorMessages() {
        const errorElements = document.getElementsByClassName('error-message');
        Array.from(errorElements).forEach(element => {
            element.innerText = '';
            element.style.display = 'none';
        });
    }

    /*******************************
     * MANUAL CROP LOGIC (4 IMGS) *
     *******************************/
    const cropStates = {};

    // Initialize references for 4 images
    for (let i = 1; i <= 4; i++) {
        cropStates[i] = {
            container: document.getElementById(`container${i}`),
            mainImage: document.getElementById(`mainImage${i}`),
            cropArea: document.getElementById(`crop-area${i}`),
            cropBtn: document.getElementById(`cropBtn${i}`),
            preview: document.getElementById(`preview${i}`),
            input: document.getElementById(`input${i}`)
        };
        initDragHandlers(i);
        initCropButton(i);
    }

    // Called on input change
    function onFileChange(event, index) {
        const state = cropStates[index];
        const input = state.input;
        const container = state.container;
        const mainImage = state.mainImage;
        const cropArea = state.cropArea;
        const cropBtn = state.cropBtn;
        const preview = state.preview;

        preview.innerHTML = ""; // Clear previous preview

        if (input.files && input.files[0]) {
            const file = input.files[0];
            const reader = new FileReader();

            reader.onload = function(ev) {
                mainImage.src = ev.target.result;
                container.style.display = 'block';
                cropBtn.style.display = 'inline-block';

                // When image is loaded, set default crop area
                mainImage.onload = function() {
                    // Simple default crop box
                    cropArea.style.left = "50px";
                    cropArea.style.top = "50px";
                    cropArea.style.width = "150px";
                    cropArea.style.height = "150px";
                };
            };

            reader.readAsDataURL(file);
        } else {
            container.style.display = 'none';
            cropBtn.style.display = 'none';
            mainImage.src = "";
            preview.innerHTML = "";
        }
    }

    // Initialize draggable behavior for a given crop-area
    function initDragHandlers(index) {
        const state = cropStates[index];
        const cropArea = state.cropArea;
        const container = state.container;

        if (!cropArea || !container) return;

        cropArea.onmousedown = function(e) {
            if (e.target !== cropArea) return;

            const rect = cropArea.getBoundingClientRect();
            const containerRect = container.getBoundingClientRect();

            const shiftX = e.clientX - rect.left;
            const shiftY = e.clientY - rect.top;

            function moveAt(ev) {
                let newLeft = ev.clientX - shiftX - containerRect.left;
                let newTop = ev.clientY - shiftY - containerRect.top;

                // Optional: keep cropArea inside container
                if (newLeft < 0) newLeft = 0;
                if (newTop < 0) newTop = 0;
                if (newLeft + cropArea.offsetWidth > container.offsetWidth) {
                    newLeft = container.offsetWidth - cropArea.offsetWidth;
                }
                if (newTop + cropArea.offsetHeight > container.offsetHeight) {
                    newTop = container.offsetHeight - cropArea.offsetHeight;
                }

                cropArea.style.left = newLeft + "px";
                cropArea.style.top = newTop + "px";
            }

            function stop() {
                document.removeEventListener("mousemove", moveAt);
                document.removeEventListener("mouseup", stop);
            }

            document.addEventListener("mousemove", moveAt);
            document.addEventListener("mouseup", stop);
        };
    }

    // Initialize crop button behavior
    function initCropButton(index) {
        const state = cropStates[index];
        const cropBtn = state.cropBtn;

        if (!cropBtn) return;

        cropBtn.onclick = function() {
            const mainImage = state.mainImage;
            const cropArea = state.cropArea;
            const preview = state.preview;
            const input = state.input;

            if (!mainImage.src) return;

            const cropRect = cropArea.getBoundingClientRect();
            const imgRect = mainImage.getBoundingClientRect();

            const left = cropRect.left - imgRect.left;
            const top = cropRect.top - imgRect.top;
            const width = cropRect.width;
            const height = cropRect.height;

            if (width <= 0 || height <= 0) return;

            const canvas = document.createElement("canvas");
            canvas.width = width;
            canvas.height = height;
            const ctx = canvas.getContext("2d");

            ctx.drawImage(mainImage, left, top, width, height, 0, 0, width, height);

            const dataUrl = canvas.toDataURL("image/png");

            // Show preview
            preview.innerHTML = `
                <h6>Cropped Image ${index}</h6>
                <img src="${dataUrl}" class="img-preview" />
            `;

            // Replace input file with cropped blob so backend gets cropped image
            canvas.toBlob(function(blob) {
                if (!blob) return;
                const fileName = `cropped-img-${Date.now()}-${index}.png`;
                const croppedFile = new File([blob], fileName, { type: "image/png" });

                const dt = new DataTransfer();
                dt.items.add(croppedFile);
                input.files = dt.files;
            }, "image/png", 1.0);
        };
    }
</script>
